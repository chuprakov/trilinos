
INCLUDE(TribitsAddExecutableAndTest)
INCLUDE(TribitsCopyFilesToBinaryDir)

SET(ARGS "--filedir=${CMAKE_CURRENT_BINARY_DIR}/")

IF (SITE STREQUAL "gabriel.sandia.gov")
  SET(ARGS
    "${ARGS} --not-unit-test=CrsMatrix_int_ComplexFloat_FullMatrixComplex_UnitTest")
ENDIF()

JOIN(allnodes   "|" FALSE ${Tpetra_ETI_NODES}  )
TRIBITS_ETI_TYPE_EXPANSION(conversions "SOUT=int" "SIN=double" "LO=int" "GO=int" "N=${allnodes}")
TRIBITS_ADD_ETI_INSTANTIATIONS(Tpetra ${conversions})

IF(Tpetra_ENABLE_Thrust)
  SET(MAXNP NUM_MPI_PROCS 1)
ENDIF()

#
# We break up CrsMatrix's unit tests into several files, to reduce
# compilation time for each file and improve build parallelism.
#

IF(Kokkos_ENABLE_Cuda)
  #
  # Add subpackage include path dependencies for CUDA_COMPILE().
  CUDA_INCLUDE_DIRECTORIES( "." )
  CUDA_INCLUDE_DIRECTORIES( ${Tpetra_INCLUDE_DIRS} )
  CUDA_COMPILE(CRSMATRIX_UT1_OBJECTS_CUDA CrsMatrix_UnitTests_CU.cu)
  CUDA_COMPILE(CRSMATRIX_UT2_OBJECTS_CUDA CrsMatrix_UnitTests2_CU.cu)
  CUDA_COMPILE(CRSMATRIX_UT3_OBJECTS_CUDA CrsMatrix_UnitTests3_CU.cu)
  CUDA_COMPILE(CRSMATRIX_UT4_OBJECTS_CUDA CrsMatrix_UnitTests4_CU.cu)
  CUDA_COMPILE(CRSMATRIX_NLAR_OBJECTS_CUDA CrsMatrix_NonlocalAfterResume_CU.cu)
  CUDA_COMPILE(CRSMATRIX_NC_OBJECTS_CUDA CrsMatrix_NodeConversion_CU.cu)
  CUDA_COMPILE(CRSMATRIX_TS_OBJECTS_CUDA CrsMatrix_TriSolve_CU.cu)
  CUDA_COMPILE(CRSMATRIX_LRS_OBJECTS_CUDA CrsMatrix_LeftRightScale_CU.cu)
  CUDA_COMPILE(CRSMATRIX_WG_OBJECTS_CUDA CrsMatrix_WithGraph_CU.cu)
  CUDA_COMPILE(CRSMATRIX_RDMAI_OBJECTS_CUDA CrsMatrix_ReplaceDomainMapAndImporter_CU.cu)
  CUDA_COMPILE(CRSMATRIX_BE_OBJECTS_CUDA CrsMatrix_BlockExtraction_CU.cu)
  CUDA_COMPILE(CRSMATRIX_NLSI_OBJECTS_CUDA CrsMatrix_NonlocalSumInto_CU.cu)
  CUDA_COMPILE(CRSMATRIX_NLSII_OBJECTS_CUDA CrsMatrix_NonlocalSumInto_Ignore_CU.cu)
  CUDA_COMPILE(CRSMATRIX_GS_OBJECTS_CUDA CrsMatrix_gaussSeidel_CU.cu)
  CUDA_COMPILE(CRSMATRIX_B5978_OBJECTS_CUDA bug5978_CU.cu)
  CUDA_COMPILE(CRSMATRIX_B6069_1_OBJECTS_CUDA Bug6069_1_CU.cu)
  CUDA_COMPILE(CRSMATRIX_B6069_2_OBJECTS_CUDA Bug6069_2_CU.cu)
ENDIF()

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_UnitTests
  SOURCES
    CrsMatrix_UnitTests
    ${CRSMATRIX_UT1_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ${ARGS}
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_UnitTests2
  SOURCES
    CrsMatrix_UnitTests2
    ${CRSMATRIX_UT2_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ${ARGS}
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_UnitTests3
  SOURCES
    CrsMatrix_UnitTests3
    ${CRSMATRIX_UT3_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ${ARGS}
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_UnitTests4
  SOURCES
    CrsMatrix_UnitTests4
    ${CRSMATRIX_UT4_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ${ARGS}
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_NonlocalAfterResume
  SOURCES
    CrsMatrix_NonlocalAfterResume
    ${CRSMATRIX_NLAR_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ""
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_NodeConversion
  SOURCES
    CrsMatrix_NodeConversion
    ${CRSMATRIX_NC_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ""
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_TriSolve
  SOURCES
    CrsMatrix_TriSolve
    ${CRSMATRIX_TS_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ""
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_LeftRightScale
  SOURCES
    CrsMatrix_LeftRightScale
    ${CRSMATRIX_LRS_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ""
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_WithGraph
  SOURCES
    CrsMatrix_WithGraph
    ${CRSMATRIX_WG_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ${ARGS}
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_ReplaceDomainMapAndImporter
  SOURCES
    CrsMatrix_ReplaceDomainMapAndImporter
    ${CRSMATRIX_RDMAI_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS ""
  ${MAXNP}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_BlockExtraction
  SOURCES
    CrsMatrix_BlockExtraction
    ${CRSMATRIX_BE_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  # ARGS ${ARGS}
  COMM serial mpi
  STANDARD_PASS_OUTPUT
  )

TRIBITS_COPY_FILES_TO_BINARY_DIR(CrsMatrixCopyFiles1
  SOURCE_FILES west0067.rua mhd1280b.cua
  EXEDEPS CrsMatrix_UnitTests
  )

ASSERT_DEFINED(Anasazi_SOURCE_DIR)
TRIBITS_COPY_FILES_TO_BINARY_DIR(CrsTests_CopyFiles2
  SOURCE_DIR ${Anasazi_SOURCE_DIR}/testmatrices
  SOURCE_FILES bcsstk14.hb bcsstk15.hb
  )

# This test only makes sense for > 1 processes.
TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_NonlocalSumInto
  SOURCES
    CrsMatrix_NonlocalSumInto
    ${CRSMATRIX_NLSI_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS
  COMM mpi
  NUM_MPI_PROCS 2-4
  STANDARD_PASS_OUTPUT
  )

# This test only makes sense for > 1 processes.
TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_NonlocalSumInto_Ignore
  SOURCES
    CrsMatrix_NonlocalSumInto_Ignore
    ${CRSMATRIX_NLSII_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS
  COMM mpi
  NUM_MPI_PROCS 2-4
  STANDARD_PASS_OUTPUT
  )

TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_gaussSeidel
  SOURCES
    CrsMatrix_gaussSeidel
    ${CRSMATRIX_GS_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS
  COMM serial mpi
  NUM_MPI_PROCS 1-4
  STANDARD_PASS_OUTPUT
  )

# This test only makes sense for exactly 2 MPI processes.
TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_Bug5978
  SOURCES
    bug5978
    ${CRSMATRIX_B5978_OBJECTS_CUDA}
    ${TEUCHOS_STD_UNIT_TEST_MAIN}
  ARGS
  COMM mpi
  NUM_MPI_PROCS 2
  STANDARD_PASS_OUTPUT
  )

# First test for Bug 6069.  This test only makes sense for exactly 3
# MPI processes.  Run under Valgrind for best results.
TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_Bug6069_1
  SOURCES
    Bug6069_1
    ${CRSMATRIX_B6069_1_OBJECTS_CUDA}
  ARGS
  COMM mpi
  NUM_MPI_PROCS 3
  STANDARD_PASS_OUTPUT
  )

# Second test for Bug 6069.  This test only makes sense for exactly 2
# MPI processes.  Run under Valgrind for best results.
TRIBITS_ADD_EXECUTABLE_AND_TEST(
  CrsMatrix_Bug6069_2
  SOURCES
    Bug6069_2
    ${CRSMATRIX_B6069_2_OBJECTS_CUDA}
  ARGS
  COMM mpi
  NUM_MPI_PROCS 2
  STANDARD_PASS_OUTPUT
  )

SET(TIMING_INSTALLS "")

#IF (KokkosClassic_ENABLE_TBB AND Tpetra_ENABLE_MPI)
#  TRIBITS_ADD_EXECUTABLE(
#      CRSTiming_TBB
#      SOURCES CRSTiming_TBB
#      COMM mpi
#      DEPLIBS kokkos kokkoslinalg kokkosnodeapi
#      )
#  APPEND_SET(TIMING_INSTALLS Tpetra_CRSTiming_TBB)
#ENDIF()

#IF (KokkosClassic_ENABLE_ThreadPool AND Tpetra_ENABLE_MPI)
#  TRIBITS_ADD_EXECUTABLE(
#      CRSTiming_TPI
#      SOURCES CRSTiming_TPI
#      COMM mpi
#      DEPLIBS kokkos kokkoslinalg kokkosnodeapi
#      )
#  APPEND_SET(TIMING_INSTALLS Tpetra_CRSTiming_TPI)
#ENDIF()

INSTALL(TARGETS ${TIMING_INSTALLS}
        RUNTIME DESTINATION "${${PROJECT_NAME}_INSTALL_RUNTIME_DIR}")
