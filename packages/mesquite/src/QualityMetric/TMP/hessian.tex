\documentstyle[leqno]{article}

\pagestyle{empty}

\title{ {\LARGE\bf Derivatives of the function $f(A)$}}

%\author{Patrick Knupp \\
%The Sandia National Laboratories \\
%Albuquerque NM USA \\
%pknupp@sandia.gov}

\date{28 October 2008}

\begin{document}

\maketitle
%\begin{abstract} 
%We list some handy formulas which relate the minimum and maximum functions.
%\end{abstract}

\section{Volume Case}

\noindent {\bf The Map.} \newline
Given a master element $M$ and a physical element 
$E$ in $\Re^3$, 
let there be a one-to-one onto map from $M$ to $E$ given by 
\begin{eqnarray}
x_m & = & x_m ( \xi_n )
\end{eqnarray}
where $m = 1, 2, 3$ and $n = 1, 2, 3$.  The map is usually a polynomial
in the coordinates $\xi_n$.  Let the physical element contain K control 
points $X_m^k$, with $k=1,\ldots,K$. The map is then generally written as 
\begin{eqnarray}
x_m & = & \sum_{k=1}^K N_k (\xi_n) X_m^k
\end{eqnarray}
with $N_k$ being the 'basis' polynomial in the master coordinates associated
with the $k^{th}$ control point. \newline

\noindent {\bf The Jacobian.} \newline
The Jacobian of the map is a $3 \times 3$ matrix
$A$, whose elements are
\begin{eqnarray}
A_{mn} = \frac{\partial x_m}{\partial \xi_n} 
\end{eqnarray}
Assuming the map has the form given in (2), we have
\begin{eqnarray}
A_{mn} = \sum_{k=1}^K \left( \frac{\partial N_k}{\partial \xi_n} \right) X_m^k 
\end{eqnarray}
The Jacobian is linear in the control points $X_m^k$. \newline

\noindent The derivative of $A_{mn}$ with respect to the control point 
coordinates is, with $\ell=1,\ldots,K$ and $p=1,2,3$
\begin{eqnarray}
\frac{\partial A_{mn}}{\partial X_p^\ell} & = &  \sum_{k=1}^K \left( \frac{\partial N_k}{\partial \xi_n} \right) \frac{\partial X_m^k}{\partial X_p^\ell} \\
  & = &  \left( \frac{\partial N_\ell}{\partial \xi_n} \right) \frac{\partial X_m^\ell}{\partial X_p^\ell} \\
  & = &  \left( \frac{\partial N_\ell}{\partial \xi_n} \right) \delta_{m p}
\end{eqnarray}

\noindent {\bf The Function $f(A)$ and its derivatives.} \newline
Let $f$ be a multi-variable function from $\Re^9$ to $\Re$, given by 
$f(A) = f(A_{11},A_{12},...,A_{33})$.  The derivative of $f$ with respect 
to $A$ is defined as the matrix $df/dA$ with elements
\begin{eqnarray}
\left( \frac{df}{dA} \right)_{ij} & = & \frac{\partial f}{\partial A_{ij}}
\end{eqnarray}
The Hessian of $f$ with respect to $A$ is a tensor $d^2 f/ dA^2$ with elements
\begin{eqnarray}
\left( \frac{d^2 f}{d A^2} \right)_{rsij} = \frac{\partial^2 f}{\partial A_{rs} \partial A_{ij}}
\end{eqnarray}

\noindent {\bf The Gradient of $f$ with respect to the Control Points.} 
\newline The gradient of $f$ with respect to the control points within an
element is defined as a vector in $\Re^{3K}$ with components 
$\frac{\partial f}{\partial X_m^k}$. We have
\begin{eqnarray}
\frac{\partial f}{\partial X_m^k} & = & \sum_{i=1}^3 \sum_{j=1}^3 \frac{\partial f}{\partial A_{ij}} \frac{\partial A_{ij}}{\partial X_m^k} \\
& = & \sum_{i=1}^3 \sum_{j=1}^3 \frac{\partial f}{\partial A_{ij}} \frac{\partial N_k}{\partial \xi_j} \delta_{im} \\
% & = & \sum_{i=1}^3 \sum_{j=1}^3 \frac{\partial f}{\partial A_{ij}} \frac{\partial}{\partial X_m^k} \left( \sum_{\ell=1}^K \frac{\partial N_\ell}{\partial \xi_j} X_i^\ell \right) \\ 
% & = & \sum_{i=1}^3 \sum_{j=1}^3 \frac{\partial f}{\partial A_{ij}} \sum_{\ell=1}^K \left( \frac{\partial N_\ell}{\partial \xi_j} \right) \frac{\partial}{\partial X_m^k} X_i^\ell  \\
 & = & \sum_{j=1}^3 \frac{\partial f}{\partial A_{mj}} \frac{\partial N_k}{\partial \xi_j}
\end{eqnarray}

\noindent {\bf The Hessian of $f$ with respect to the Control Points.} \newline
The Hessian of $f$ with respect to the control points within an element is 
defined as a $3K \times 3K$ matrix with components $\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k}$, with $\ell=1,\ldots,K$.  We have
\begin{eqnarray}
\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k} & = & \frac{\partial}{\partial X_n^\ell} \left( \sum_{j=1}^3 \frac{\partial f}{\partial A_{mj}} \frac{\partial N_k}{\partial \xi_j} \right) \\
& = & \sum_{j=1}^3  \frac{\partial}{\partial X_n^\ell} \left( \frac{\partial f}{\partial A_{mj}} \frac{\partial N_k}{\partial \xi_j} \right) \\
& = & \sum_{j=1}^3  \left\{ \frac{\partial}{\partial X_n^\ell} \left( \frac{\partial f}{\partial A_{mj}} \right) \right\} \frac{\partial N_k}{\partial \xi_j} \\
& = & \sum_{j=1}^3  \left\{ \sum_{r=1}^3 \sum_{s=1}^3 \frac{\partial}{\partial A_{rs}} \left( \frac{\partial f}{\partial A_{mj}} \right) \frac{\partial A_{rs}}{\partial X_n^\ell} \right\} \frac{\partial N_k}{\partial \xi_j} \\
& = & \sum_{j=1}^3  \left\{ \sum_{r=1}^3 \sum_{s=1}^3 \left( \frac{\partial^2 f}{\partial A_{rs} \partial A_{mj}} \right) \frac{\partial N_\ell}{\partial \xi_s} \delta_{rn} \right\} \frac{\partial N_k}{\partial \xi_j} \\
& = & \label{eqn:vol-hess} \sum_{j=1}^3  \sum_{s=1}^3 \left( \frac{\partial^2 f}{\partial A_{ns} \partial A_{mj}} \right) \frac{\partial N_\ell}{\partial \xi_s} \frac{\partial N_k}{\partial \xi_j}
\end{eqnarray}
For simple $f(A)$'s the Hessian will be sparse. \newline

\noindent Equation (\ref{eqn:vol-hess}) can be expressed using matrix multiplication as follows:

\begin{equation} \label{eqn:vol-hess-mat}
\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k} =
(\nabla N_l)^t \frac{\partial^2 f}{\partial A_n \partial A_m} \nabla N_k
\end{equation}
where $\nabla N_k = \left[\begin{array}{c} 
\frac{\partial N_k}{\partial \xi_1} \\
\frac{\partial N_k}{\partial \xi_2} \\
\frac{\partial N_k}{\partial \xi_3} \end{array}\right]$ 
and $\frac{\partial^2 f}{\partial A_n \partial A_m} = \left[\begin{array}{ccc}
\frac{\partial^2 f}{\partial A_{n,1} \partial A_{m,1}} &
\frac{\partial^2 f}{\partial A_{n,1} \partial A_{m,2}} &
\frac{\partial^2 f}{\partial A_{n,1} \partial A_{m,3}} \\
\frac{\partial^2 f}{\partial A_{n,2} \partial A_{m,1}} &
\frac{\partial^2 f}{\partial A_{n,2} \partial A_{m,2}} &
\frac{\partial^2 f}{\partial A_{n,2} \partial A_{m,3}} \\
\frac{\partial^2 f}{\partial A_{n,3} \partial A_{m,1}} &
\frac{\partial^2 f}{\partial A_{n,3} \partial A_{m,2}} &
\frac{\partial^2 f}{\partial A_{n,3} \partial A_{m,3}} \end{array}\right]$.\newline


\noindent Note that all these derivatives are local quantities, say at a sample point.  There would also be a global gradient and Hessian that can be assembled from these local pieces. \newline

\noindent {\bf The function $f(T)$ and it's derivatives} \newline
For the case $T = A W^{-1}$, some of the metrics are of the form $f=f(T)$,
which is, indirectly, still a function of $A$.  For convennience, let
$Z = W^{-1}$.  Then $T = A Z$, so that 
\begin{eqnarray}
T_{rs} = \sum_{k=1}^3 A_{rk} Z_{ks}
\end{eqnarray}
and 
\begin{eqnarray}
\frac{\partial T_{rs}}{\partial A_{ij}} & = & \sum_{k=1}^3 \frac{\partial A_{rk}}{\partial A_{ij}} Z_{ks} \\
 & = & \sum_{k=1}^3 \delta_{ri} \delta_{kj} Z_{ks} \\
 & = & \delta_{ri} \sum_{k=1}^3 \delta_{kj} Z_{ks} \\
 & = & \delta_{ri} Z_{js}
\end{eqnarray}
Then we have
\begin{eqnarray}
\frac{\partial f}{\partial A_{ij}} & = & \sum_{r=1}^3 \sum_{s=1}^3 \frac{\partial f}{\partial T_{rs}} \frac{\partial T_{rs}}{\partial A_{ij}} \\
 & = & \sum_{r=1}^3 \sum_{s=1}^3 \frac{\partial f}{\partial T_{rs}} \delta_{ri} Z_{js} \\
 & = & \sum_{r=1}^3 \delta_{ri} \sum_{s=1}^3 \frac{\partial f}{\partial T_{rs}} Z_{sj}^t \\
 & = & \sum_{s=1}^3 \frac{\partial f}{\partial T_{is}} Z_{sj}^t 
\end{eqnarray}
or, more compactly,
\begin{eqnarray}
\frac{\partial f}{\partial A} = \frac{\partial f}{\partial T} W^{-t}
\end{eqnarray}
Similarly, we have for the Hessian of $f(T)$
\begin{eqnarray}
\frac{\partial^2 f}{\partial A_{pq} \partial A_{ij}} & = & \sum_{s=1}^3 \frac{\partial}{\partial A_{pq}} \left( \frac{\partial f}{\partial T_{is}} \right) Z_{sj}^t \\
 & = & \sum_{s=1}^3 \sum_{p=1}^3 \sum_{q=1}^3  Z_{sj}^t \frac{\partial T_{pq}}{\partial A_{pq}}  \frac{\partial}{\partial T_{pq}} \left( \frac{\partial f}{\partial T_{is}} \right) \\
 & = & \sum_{s=1}^3 \sum_{p=1}^3 \sum_{q=1}^3  Z_{sj}^t Z_{qq} \left( \frac{\partial^2 f}{\partial T_{pq} \partial T_{is}} \right)
\end{eqnarray}

\section{Surface Case}

\noindent {\bf The Map.} \newline
Given a 2D master element $M$ and a physical surface element 
$E$ in $\Re^3$, let there be a one-to-one onto map from $M$ to $E$ given by 
\begin{eqnarray}
x_m & = & x_m ( \xi_n )
\end{eqnarray}
where $m = 1, 2, 3$ and $n = 1, 2$.  The map is usually a polynomial
in the coordinates $\xi_n$.  Let the physical element contain K control 
points $X_m^k$, with $k=1,\ldots,K$. The map is then generally written as 
\begin{eqnarray}
x_m & = & \sum_{k=1}^K N_k (\xi_n) X_m^k
\end{eqnarray}
with $N_k$ being the 'basis' polynomial in the master coordinates associated
with the $k^{th}$ control point. \newline

\noindent {\bf The Jacobian.} \newline
The Jacobian of the map is a $3 \times 2$ matrix
$J$, whose elements are
\begin{eqnarray}
J_{mn} = \frac{\partial x_m}{\partial \xi_n} 
\end{eqnarray}
Assuming the map has the form given in (33), we have
\begin{eqnarray}
J_{mn} = \sum_{k=1}^K \left( \frac{\partial N_k}{\partial \xi_n} \right) X_m^k 
\end{eqnarray}
The Jacobian is linear in the control points $X_m^k$. \newline

\noindent The derivative of $J_{mn}$ with respect to the control point 
coordinates is, with $\ell=1,\ldots,K$ and $p=1,2,3$
\begin{eqnarray}
\frac{\partial J_{mn}}{\partial X_p^\ell} & = &  \sum_{k=1}^K \left( \frac{\partial N_k}{\partial \xi_n} \right) \frac{\partial X_m^k}{\partial X_p^\ell} \\
  & = &  \left( \frac{\partial N_\ell}{\partial \xi_n} \right) \frac{\partial X_m^\ell}{\partial X_p^\ell} \\
  & = &  \left( \frac{\partial N_\ell}{\partial \xi_n} \right) \delta_{m p}
\end{eqnarray}

\noindent {\bf Dependence of $A_{2 \times 2}$ on $J$} \newline
The surface mesh optimization algorithm requires that $J_{3 \times 2}$ be 
converted to a matrix $A_{2 \times 2}$ so that the 2D TMP metrics can be 
used.\footnote{In previous writings we used the notation $A^{\prime\prime}$ for $J$.} Similarly, the target matrix is $W^\prime_{3 \times 2}$, which is converted to the matrix $W_{2 \times 2}$. Elements of $A_{2 \times 2}=(RZ)^t J$ 
are given by
\begin{eqnarray}
A_{ij} = \sum_{r=1}^3 \sum_{s=1}^3 \left( Z^t \right)_{ir} \left( R^t \right)_{rs} \left( J \right)_{sj}
\end{eqnarray}
for $i=1,2$ and $j=1,2$. We seek the derivative of the elements of $A$ with
respect to the control point coordinates. 
First, recall that $Z$ is independent of the control
point coordinates $X_m^k$ because the matrix is constructed from the 
$3 \times 2$ target matrix.  Second, the derivatives of $J$ with respect to
these coordinates have already been given in (38) above.  Third, the matrix $R$ is 
defined as $R = [{\bf v},{\bf n}_J,{\bf v} \times {\bf n}_J][{\bf v},{\bf n}_r,{\bf v} \times {\bf n}_r]^t$, where ${\bf N}_J = {\bf j}_1 \times {\bf j}_2$, 
with $J= [{\bf j}_1,{\bf j}_2]$ and ${\bf n}_J={\bf N}_J/|{\bf N}_J|$.
Additionally, let ${\bf N}_w^\prime = {\bf w}_1^\prime \times {\bf w}_2^\prime$, ${\bf n}_w^\prime = {\bf N}_w^\prime/|{\bf N}_w^\prime|$, so that 
${\bf n}_r = {\bf n}_w^\prime$ if ${\bf n}_J \cdot {\bf n}_w^\prime>0$ and 
-${\bf n}_w^\prime$ otherwise. Thus, ${\bf v}$ and ${\bf n}_J$ depend on 
$X_m^k$ while the other vectors do not. The dependence of $R$ on the control
point coordinates is thus complex. \newline

\noindent Small changes in the control point coordinates can result in large 
changes to $R$ if the surface curvature is large compared to the size
of the mesh elements. When the mesh under-resolves the surface curvature, 
one expects any mesh optimization algorithm that uses 'snap-to' 
functionality to fare poorly, so accuracy of the derivative of $R$ is  
immaterial.  \newline
 
\noindent For meshes that resolve the 
surface well, (i.e., have elements that are small compared to the radius of 
curvature), $R$ is a slowly-varying function of the 
control point coordinates.  In other words, when the surface is well resolved 
by the mesh elements, ${\bf n}_J$ is close to ${\bf n}_r$ and small
changes in the control point coordinates will result in small changes to $R$. 
The special case of a planar mesh is an example of this since then 
$R=I_{3 \times 3}$ is constant. Therefore, {\it we assume that the derivative 
of $R$ with respect to the control point coordinates is zero.} \newline

\noindent {\bf The Function $f(A)$ and its derivatives.} \newline
Let $f$ be a multi-variable function from $\Re^4$ to $\Re$, given by 
$f(A) = f(A_{11},A_{12},...,A_{22})$.  The derivative of $f$ with respect 
to $A$ is defined as the matrix $df/dA$ with elements
\begin{eqnarray}
\left( \frac{df}{dA} \right)_{ij} & = & \frac{\partial f}{\partial A_{ij}}
\end{eqnarray}
The Hessian of $f$ with respect to $A$ is a tensor $d^2 f/ dA^2$ with elements
\begin{eqnarray}
\left( \frac{d^2 f}{d A^2} \right)_{rsij} = \frac{\partial^2 f}{\partial A_{rs} \partial A_{ij}}
\end{eqnarray}

\noindent {\bf The Gradient of $f$ with respect to the Control Points.} 
\newline The gradient of $f$ with respect to the control points within an
element is defined as a vector in $\Re^{3K}$ with components 
$\frac{\partial f}{\partial X_m^k}$. We have
\begin{eqnarray}
\frac{\partial f}{\partial X_m^k} & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial A_{ij}}{\partial X_m^k} \nonumber \\
 & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial}{\partial X_m^k} \left\{ \left( RZ \right)^t J \right\}_{ij} \nonumber \\
 & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial}{\partial X_m^k} \left\{ \sum_{r=1}^3  \left[ (RZ)^t \right]_{ir} \left[ J \right]_{rj} \right\} \nonumber \\
 & \approx & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \left\{ \sum_{r=1}^3  \left[ (RZ)^t \right]_{ir}  \frac{\partial}{\partial X_m^k} \left[ J \right]_{rj} \right\} \nonumber \\
 & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \left\{ \sum_{r=1}^3  \left[ (RZ)^t \right]_{ir}  \left( \frac{\partial N_{k}}{\partial \xi_j} \right) \delta_{rm} \right\} \nonumber \\
 & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}}  \left( \frac{\partial N_{k}}{\partial \xi_j} \right) \left\{ \sum_{r=1}^3  \left[ (RZ)^t \right]_{ir} \delta_{rm} \right\} \nonumber \\
 & = & \sum_{i=1}^2 \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial N_k}{\partial \xi_j} \left( RZ \right)_{mi} \nonumber \\
 \label{eqn:surfgrad} & = & \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial N_k}{\partial \xi_j} 
\end{eqnarray}
Note the similarities and difference with equation (12). If 
$RZ = I$, as in the planar case, then this reduces to equation (12),
except the sums go from 1 to 2. \newline

\noindent Equation (\ref{eqn:surfgrad}) can be expressed using matrix operations:

\begin{equation}
\frac{\partial f}{\partial X^k} = R Z \frac{\partial f}{\partial A} \nabla N_k
\end{equation}

where $\frac{\partial f}{\partial X^k} = \left[ \begin{array}{c} 
\frac{\partial f}{\partial X^k_1} \\
\frac{\partial f}{\partial X^k_2} \\
\frac{\partial f}{\partial X^k_3} \end{array} \right]$
and $\nabla N_k = \left[ \begin{array}{c} 
\frac{\partial N_k}{\partial \xi_1} \\
\frac{\partial N_k}{\partial \xi_2} \end{array} \right]$.


\noindent {\bf The Hessian of $f$ with respect to the Control Points.} \newline
The Hessian of $f$ with respect to the control points within an element is 
defined as a $3K \times 3K$ matrix with components $\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k}$, with $\ell=1,\ldots,K$.  We have
\begin{eqnarray}
\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k} & = & \frac{\partial}{\partial X_n^\ell} \left( \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2 \frac{\partial f}{\partial A_{ij}} \frac{\partial N_k}{\partial \xi_j} \right) \nonumber \\
& \approx &\sum_{i=1}^2 \left( RZ \right)_{mi} \sum_{j=1}^2  \frac{\partial}{\partial X_n^\ell}  \left( \frac{\partial f}{\partial A_{ij}} \right) \frac{\partial N_k}{\partial \xi_j} \nonumber \\
& = & \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2  \frac{\partial N_k}{\partial \xi_j} \left\{ \sum_{r=1}^2 \sum_{s=1}^2 \frac{\partial A_{rs}}{\partial X_{n}^\ell} \frac{\partial}{\partial A_{rs}}  \left(  \frac{\partial f}{\partial A_{ij}}  \right) \right\}  \nonumber \\
& = & \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2  \frac{\partial N_k}{\partial \xi_j} \left\{ \sum_{r=1}^2 \sum_{s=1}^2 \frac{\partial A_{rs}}{\partial X_{n}^\ell} \left(  \frac{\partial^2 f}{\partial A_{rs} \partial A_{ij}}  \right) \right\}  \nonumber \\
& \approx & \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2 \frac{\partial N_k}{\partial \xi_j} \left\{ \sum_{r=1}^2 \sum_{s=1}^2 \left( RZ \right)_{rn}^t \frac{\partial N_\ell}{\partial \xi_s} \left( \frac{\partial^2 f}{\partial A_{rs} \partial A_{ij}}  \right)  \right\}  \nonumber \\
& = & \label{eqn:surf-hess-sum} \sum_{i=1}^2  \left( RZ \right)_{mi} \sum_{j=1}^2 \frac{\partial N_k}{\partial \xi_j} \left\{ \sum_{r=1}^2  \left( RZ \right)_{rn}^t \sum_{s=1}^2 \frac{\partial N_\ell}{\partial \xi_s} \left( \frac{\partial^2 f}{\partial A_{rs} \partial A_{ij}}  \right)  \right\} 
\end{eqnarray}
Note the similarities and difference with equation (18). If 
$RZ = I$, as in the planar case, then the Hessian reduces to equation (18),
except the sums go from 1 to 2.\newline

\noindent Equation (\ref{eqn:surf-hess-sum}) can be reordered as:

\begin{eqnarray}
\frac{\partial^2 f}{\partial X_n^\ell \partial X_m^k} 
&=& \sum_{i=1}^2 \sum_{r=1}^2 (RZ)_{m,i} (RZ)^t_{r,n}
    \sum_{j=1}^2 \sum_{s=1}^2 \frac{\partial N_k}{\partial \xi_j}
    \frac{\partial N_\ell}{\partial \xi_s}
    \left( \frac{\partial^2 f}{\partial A_i \partial A_r} \right)_{j,s} 
    \nonumber \\
&=& \label{eqn:surf-hess-summat} 
    \sum_{i=1}^2 \sum_{r=1}^2 (RZ)_{m,i} (RZ)^t_{r,n} 
    \left[ (\nabla N_\ell)^t \frac{\partial^2 f}{\partial A_i \partial A_r}
            \nabla N_k \right] 
\end{eqnarray}

\noindent For a purely 2-dimensional case, a block of the Hessian containing 
derivatives with respect to the coordinates of two vertices $Y^\ell$ and $Y^k$ is:
\begin{equation} \label{eqn:hess-2d}
\frac{\partial^2 g}{\partial Y^\ell \partial Y^k} =
\left[ \begin{array}{cc}
\frac{\partial^2 g}{\partial Y^\ell_1 \partial Y^k_1} &
\frac{\partial^2 g}{\partial Y^\ell_1 \partial Y^k_2} \\
\frac{\partial^2 g}{\partial Y^\ell_2 \partial Y^k_1} &
\frac{\partial^2 g}{\partial Y^\ell_2 \partial Y^k_2} 
\end{array} \right] \end{equation}
\noindent And analogous to the 3-dimensional case from equation:
(\ref{eqn:vol-hess-mat}):
\begin{equation}
\left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k}\right)_{i,r}
= \frac{\partial^2 g}{\partial Y^\ell_i \partial Y^k_r}
= (\nabla N_\ell)^t \frac{\partial^2 f}{\partial A_i \partial A_r} \nabla N_k
\end{equation}
\noindent A block of the Hessian for the surface case can be expressed in terms of the corresonding 2D Hessian:
\begin{equation} \label{eqn:surf-hess-mat}
\frac{\partial^2 f}{\partial X^\ell \partial X^k}
= (RZ) \left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k}\right)^t (RZ)^t
\end{equation}
\noindent A single element $n,m$ of equation (\ref{eqn:surf-hess-mat}) is:
\begin{eqnarray}
\left(\frac{\partial^2 f}{\partial X^\ell \partial X^k}\right)_{n,m}
&=& \frac{\partial^2 f}{\partial X^\ell_n \partial X^k_m} \nonumber \\
&=& \left[(RZ) \left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k} \right)^t  (RZ)^t\right]_{n,m} 
    \nonumber \\
&=& \sum_{r=1}^2 (RZ)_{n,r} \left[ \left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k} \right)^t
    (RZ)^t \right]_{r,m} \nonumber \\
&=& \sum_{r=1}^2 (RZ)_{n,r} \sum_{i=1}^2 
    \left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k}\right)^t_{r,i} (RZ)^t_{i,m} 
    \nonumber \\
&=& \sum_{r=1}^2 (RZ)^t_{r,n} \sum_{i=1}^2 
    \left(\frac{\partial^2 g}{\partial Y^\ell \partial Y^k}\right)_{i,r} (RZ)_{m,i} 
    \nonumber \\
&=& \sum_{r=1}^2 \sum_{i=1}^2 (RZ)^t_{r,n} (RZ)_{m,i} \left[
    (\nabla N_\ell)^t \frac{\partial^2 f}{\partial A_i \partial A_r} \nabla N_k
    \right] \nonumber
\end{eqnarray}
\noindent which is equation (\ref{eqn:surf-hess-summat}). \newline

\noindent In the planer case ($RZ = I$), equation (\ref{eqn:surf-hess-mat}) results in 
a $3 \times 3$  matrix where the upper left $2 \times 2$ sub-block is exactly the 
corresponding Hessian block from 
the two-dimensional case and all terms corresponding to derivatives with respect to the 
coordinate of the third dimension are zero.  Each vertex-block of both the first and second derivatives is a transform using $RZ$ applied to the corresponding vertex-block from the 
two-dimensional derivatives.

\end{document}

