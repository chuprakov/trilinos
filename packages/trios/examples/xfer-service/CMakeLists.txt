INCLUDE(PackageAddExecutable)
INCLUDE(PackageAddTest)
INCLUDE(AddOptionAndDefine)
INCLUDE(ProcessXDR)

############# Special exception for rpcgen extra commas in enum ##########
IF (CMAKE_COMPILER_IS_GNUCXX)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fpermissive")
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
  SET(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -isystem ${CMAKE_CURRENT_BINARY_DIR}")
ENDIF (CMAKE_COMPILER_IS_GNUCXX)

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})


# We want the binary directory to be a system directory because it contains
# code generated by rpcgen, may have many warnings. 
#INCLUDE_DIRECTORIES(SYSTEM ${CMAKE_CURRENT_BINARY_DIR})

# Generate the XDR header and source file for the service arguments
ProcessXDR(${CMAKE_CURRENT_SOURCE_DIR}/xfer_service_args.x)



PACKAGE_ADD_EXECUTABLE(
  XferServiceTest
  SOURCES xfer_service_args.c xfer_server.cpp xfer_service_test.cpp xfer_client.cpp
  DEPLIBS ${DEPLIBS}
)

SET(EXTRA_TEST_ARGS "")

# Gemini network transport takes a few seconds to initialize
IF (${PACKAGE_NAME}_ENABLE_Gemini)
  APPEND_SET(EXTRA_TEST_ARGS "--delay=3")
ENDIF()


SET(TESTNAMES 
   push-sync
   push-async
   pull-sync
   pull-async
   roundtrip-sync
   roundtrip-async
   get-sync
   get-async)


foreach (testname ${TESTNAMES})
  PACKAGE_ADD_TEST(
    XferServiceTest
    NAME XferService_${testname}
    ARGS "--io-method=${testname} ${EXTRA_TEST_ARGS}"
    COMM serial mpi
    NUM_MPI_PROCS 2)
  
  #SET_TESTS_PROPERTIES(${PACKAGE_NAME}_XferService_${testname}_MPI_2 PROPERTIES TIMEOUT 10)
endforeach()

    
